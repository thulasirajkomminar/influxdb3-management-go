name: Sync OpenAPI Specs

on:
  schedule:
    # Run monthly on the 1st day at 6:00 AM UTC
    - cron: "0 6 1 * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-specs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.5"

      - name: Download latest OpenAPI specs
        run: |
          # Create temporary directory for new specs
          mkdir -p temp_specs/cloud temp_specs/core temp_specs/enterprise

          # Download Cloud Dedicated spec
          curl -f -o temp_specs/cloud/openapi.yml \
            https://raw.githubusercontent.com/influxdata/docs-v2/master/api-docs/influxdb3/cloud-dedicated/management/openapi.yml

          # Download Core spec  
          curl -f -o temp_specs/core/ref.yml \
            https://raw.githubusercontent.com/influxdata/docs-v2/master/api-docs/influxdb3/core/v3/ref.yml

          # Download Enterprise spec
          curl -f -o temp_specs/enterprise/ref.yml \
            https://raw.githubusercontent.com/influxdata/docs-v2/master/api-docs/influxdb3/enterprise/v3/ref.yml

      - name: Check for changes
        id: check-changes
        run: |
          changes_detected=false

          # Check Cloud spec
          if ! cmp -s temp_specs/cloud/openapi.yml specs/cloud/openapi.yml; then
            echo "Changes detected in Cloud spec"
            changes_detected=true
          fi

          # Check Core spec
          if ! cmp -s temp_specs/core/ref.yml specs/core/ref.yml; then
            echo "Changes detected in Core spec"
            changes_detected=true
          fi

          # Check Enterprise spec
          if ! cmp -s temp_specs/enterprise/ref.yml specs/enterprise/ref.yml; then
            echo "Changes detected in Enterprise spec"
            changes_detected=true
          fi

          echo "changes_detected=$changes_detected" >> $GITHUB_OUTPUT

      - name: Update specs and regenerate code
        if: steps.check-changes.outputs.changes_detected == 'true'
        run: |
          # Copy new specs
          cp temp_specs/cloud/openapi.yml specs/cloud/openapi.yml
          cp temp_specs/core/ref.yml specs/core/ref.yml
          cp temp_specs/enterprise/ref.yml specs/enterprise/ref.yml

          # Regenerate Go code
          go generate ./...

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: update OpenAPI specs and regenerate client code"
          title: "chore: sync OpenAPI specs from upstream"
          body: |
            ## ğŸ”„ Automated OpenAPI Spec Sync

            This PR was automatically generated to sync the OpenAPI specifications with the latest versions from the InfluxData documentation repository.

            ### Changes
            - ğŸŒ¤ï¸ **InfluxDB Cloud Dedicated**: Updated management API spec
            - ğŸ—ï¸ **InfluxDB Core**: Updated v3 API spec  
            - ğŸ¢ **InfluxDB Enterprise**: Updated v3 API spec

            ### What's Updated
            - OpenAPI specification files in `specs/` directory
            - Generated Go client code in `cloud/`, `core/`, and `enterprise/` packages

            ### Verification
            - [ ] Specs downloaded successfully
            - [ ] Go code generation completed without errors
            - [ ] All tests pass (if applicable)

            ---
            ğŸ¤– This is an automated PR created by the sync workflow.
          branch: automated/sync-openapi-specs
          delete-branch: true

      - name: Cleanup
        run: rm -rf temp_specs
